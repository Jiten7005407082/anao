<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Tambola â€” Host Controlled (GitHub Pages)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#071427;--card:#0b1320;--accent:#ffd166;--accent-2:#06b6d4;--muted:#94a3b8;--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;color:#e6eef6;background:linear-gradient(180deg,#021222 0%, #052233 100%);-webkit-font-smoothing:antialiased}
    .wrap{max-width:1100px;margin:18px auto;padding:18px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(3,8,20,0.6);border:1px solid rgba(255,255,255,0.02)}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type=text]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    button{background:var(--accent);border:none;color:#072022;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .muted-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px;border-radius:10px;cursor:pointer}
    .small{font-size:13px;color:var(--muted)}
    .ticket{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));padding:12px;border-radius:10px}
    .ticket-grid{display:grid;grid-template-columns:repeat(9,1fr);gap:6px}
    .cell{height:52px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:16px;background:rgba(255,255,255,0.02);color:#dbeafe}
    .blank{background:transparent;color:transparent;font-weight:400}
    .called{background:linear-gradient(180deg, #ffe8a8, #ffd166);color:#091827;box-shadow:0 6px 18px rgba(255,209,102,0.12)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .called-numbers{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
    .chip{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:10px;font-weight:700}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    .linkbox{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;font-size:13px}
    .voice-toggle{display:flex;gap:8px;align-items:center}
    footer{margin-top:14px;color:var(--muted);font-size:13px}
    .tag{font-size:12px;padding:4px 8px;border-radius:8px;background:rgba(255,255,255,0.02);color:var(--muted)}
    @media(max-width:880px){.grid{grid-template-columns:1fr} .cell{height:44px;font-size:14px}}  
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Mini Tambola â€” Host Controlled (GitHub Pages)</h1>
      <div class="small">Static host + client sync â€¢ Voice announcer (GB)</div>
    </header>

    <div class="grid">
      <!-- LEFT: Room / Host Controls -->
      <div class="card">
        <div>
          <label>Room Code (share with players)</label>
          <input id="roomCode" type="text" value="ROOM123" />
        </div>

        <div style="margin-top:10px" class="flex-between">
          <div class="row">
            <label style="margin:0">Role</label>
            <div style="display:flex;gap:8px;margin-left:8px">
              <button id="modeHost" class="small">Host</button>
              <button id="modePlayer" class="small muted-btn">Player</button>
            </div>
          </div>
          <div class="voice-toggle">
            <label class="small" style="margin:0">Voice</label>
            <select id="voiceSelect" class="muted-btn" style="padding:6px;border-radius:8px">
              <option value="gb">British English (GB)</option>
              <option value="us">American English (US)</option>
            </select>
            <button id="voiceOnOff" class="muted-btn">ðŸ”ˆ On</button>
          </div>
        </div>

        <div id="hostControls" style="display:block;margin-top:12px">
          <label>Host Controls</label>
          <div class="controls">
            <button id="startGame">Start Game</button>
            <button id="callNext">Call Next Number</button>
            <button id="resetCalled" class="muted-btn">Reset Called</button>
            <button id="copyState" class="muted-btn">Copy State Link</button>
            <button id="exportState" class="muted-btn">Export State Text</button>
            <button id="downloadTicketImg" class="muted-btn">Download Ticket PNG</button>
          </div>

          <div style="margin-top:10px" class="small">Called Numbers</div>
          <div id="calledList" class="called-numbers"></div>
        </div>

        <div id="playerControls" style="display:none;margin-top:8px">
          <label>Player Controls</label>
          <div class="row" style="margin-top:6px">
            <input id="playerName" type="text" placeholder="Your name (for deterministic ticket)" />
            <button id="getTicket" class="small" style="margin-left:8px">Get Ticket</button>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="syncFromLink" class="muted-btn">Paste State Text</button>
            <button id="clearMarks" class="muted-btn">Clear Marks</button>
          </div>
        </div>

        <footer>
          Tips: Host clicks <strong>Start Game</strong> then <strong>Call Next Number</strong>. Use <strong>Copy State Link</strong> to share the current called numbers with players. Voice annnouncer uses your browser's speech synthesis.
        </footer>
      </div>

      <!-- RIGHT: Ticket & Game View -->
      <div class="card">
        <div class="flex-between">
          <div>
            <label>Active Game</label>
            <div id="activeInfo" class="small">Not started</div>
          </div>
          <div class="row">
            <div class="small">Last called:</div>
            <div id="lastCalled" class="chip">â€”</div>
          </div>
        </div>

        <hr style="border:none;height:10px;opacity:0.02" />

        <div style="display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap">
          <div style="flex:1;min-width:260px">
            <label>Ticket</label>
            <div id="ticketArea" class="ticket" style="margin-top:8px">
              <div id="ticketGrid" class="ticket-grid"></div>
            </div>

            <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
              <button id="regenTicket" class="muted-btn">Regenerate Ticket</button>
              <button id="downloadTicket" class="muted-btn">Download PNG</button>
              <div id="ticketName" class="small" style="margin-left:auto;color:var(--muted)"></div>
            </div>
          </div>

          <div style="width:280px;min-width:240px">
            <label>Called Numbers (quick view)</label>
            <div id="calledGrid" class="ticket" style="margin-top:8px;padding:12px">
              <div id="calledGridInner" class="ticket-grid"></div>
            </div>

            <div style="margin-top:10px">
              <label>Share / Sync</label>
              <div class="linkbox" id="shareBox">No state copied</div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- html2canvas for quick ticket snapshot -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5YfX8O7H2zqGgT6g2H0c1c1y1uFz7hE3Zf9x1r4iYjUQ1GzQv3wR1y5qf6aK8GQd1j2h3g4h5j6k7l8m9n==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
// -------------------------- Utilities --------------------------
function xfnv1a(str){for(var i=0,h=2166136261>>>0;i<str.length;i++)h=h^str.charCodeAt(i),h=(h+((h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24)))>>>0;return function(){h=Math.imul(h^(h>>>15),2246822507);h=Math.imul(h^(h>>>13),3266489909);return(h^=h>>>16)>>>0;};}
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;};}
function seededRandom(seedStr){const h=xfnv1a(seedStr)();return mulberry32(h());}
function el(id){return document.getElementById(id)}

// -------------------------- Ticket generation --------------------------
function generateTicket(seed){const rand=seededRandom(seed+':ticket');let nums=[];while(nums.length<15){const n=Math.floor(rand()*90)+1;if(!nums.includes(n))nums.push(n);}nums.sort((a,b)=>a-b);const cols=Array.from({length:9},()=>[]);nums.forEach(n=>{const c=Math.min(8,Math.floor((n-1)/10));cols[c].push(n)});const rows=Array.from({length:3},()=>Array(9).fill(null));const rowCounts=[0,0,0];for(let c=0;c<9;c++){const colNums=cols[c].slice();colNums.sort(()=>rand()-0.5);for(const val of colNums){let candidates=[0,1,2].filter(r=>rowCounts[r]<5);candidates.sort((a,b)=>rowCounts[a]-rowCounts[b]);const r=candidates[0]!==undefined?candidates[0]:(Math.floor(rand()*3));rows[r][c]=val;rowCounts[r]++;}}const flatRemaining=nums.filter(n=>!rows.flat().includes(n));for(let num of flatRemaining){const c=Math.min(8,Math.floor((num-1)/10));let placed=false;for(let r=0;r<3;r++){if(rows[r][c]===null&&rowCounts[r]<5){rows[r][c]=num;rowCounts[r]++;placed=true;break;}}if(!placed){for(let r=0;r<3;r++){if(rowCounts[r]<5){for(let cc=0;cc<9;cc++)if(rows[r][cc]===null){rows[r][cc]=num;rowCounts[r]++;placed=true;break;}if(placed)break;}}}for(let r=0;r<3;r++){while(rowCounts[r]<5){let donor=rowCounts.findIndex(x=>x>5);if(donor===-1)break;let moved=false;for(let c=0;c<9;c++){if(rows[donor][c]!==null&&rows[r][c]===null){rows[r][c]=rows[donor][c];rows[donor][c]=null;rowCounts[r]++;rowCounts[donor]--;moved=true;break;}}if(!moved)break;}}return rows;}

// -------------------------- Nicknames (classic-ish UK calls) --------------------------
const nicknames = {
  1:"Kelly's eye",
  2:"One little duck",
  3:"Cup of tea",
  4:"Knock at the door",
  5:"Man alive",
  6:"Half a dozen",
  7:"Lucky seven",
  8:"Garden gate",
  9:"Doctor's orders",
  10:"Blind ten",
  11:"Legs eleven",
  12:"One dozen",
  13:"Unlucky for some",
  14:"Valentine's Day",
  15:"Young and keen",
  16:"Sweet sixteen",
  17:"Dancing Queen",
  18:"Coming of age",
  19:"Goodbye teens",
  20:"One score",
  21:"Key of the door",
  22:"Two little ducks",
  23:"Thee and me",
  24:"Two dozen",
  25:"Duck and dive",
  26:"Pick and mix",
  27:"Gateway to heaven",
  28:"Over weight",
  29:"Rise and shine",
  30:"Dirty Gertie",
  31:"Get up and run",
  32:"Buckle my shoe",
  33:"Dirty knee",
  34:"Ask for more",
  35:"Jump and jive",
  36:"Three dozen",
  37:"More than eleven",
  38:"Christmas cake",
  39:"Steps",
  40:"Life begins",
  41:"Time for fun",
  42:"Answer to life",
  43:"Down on your knees",
  44:"Droopy drawers",
  45:"Halfway there",
  46:"Up to tricks",
  47:"Four and seven",
  48:"Four dozen",
  49:"PC",
  50:"Half a century",
  51:"Tweak of the thumb",
  52:"Danny La Rue",
  53:"Stuck in the tree",
  54:"Clean the floor",
  55:"All the fives",
  56:"Shottsford Scotch",
  57:"Heinz varieties",
  58:"Make them wait",
  59:"Brighton line",
  60:"Five dozen",
  61:"Baker's bun",
  62:"Turn on the screw",
  63:"Tickle me 63",
  64:"Red bus",
  65:"Old age pension",
  66:"Clickety click",
  67:"Made in heaven",
  68:"Saving grace",
  69:"Either way up",
  70:"Three score and ten",
  71:"Bang on the drum",
  72:"Six dozen",
  73:"Queen bee",
  74:"Candy store",
  75:"Strive and thrive",
  76:"Trombones",
  77:"Sunset strip",
  78:"Heaven's gate",
  79:"One more time",
  80:"Eight and blank",
  81:"Stop and run",
  82:"Straight on through",
  83:"Time for tea",
  84:"Seven dozen",
  85:"Staying alive",
  86:"Between the sticks",
  87:"Sun and fun",
  88:"Two fat ladies",
  89:"Nearly there",
  90:"Top of the shop"
};

function nicknameFor(n){ return nicknames[n] || '' }

// -------------------------- DOM render --------------------------
function renderTicket(rows){ const grid = el('ticketGrid'); grid.innerHTML=''; for(let r=0;r<3;r++){ for(let c=0;c<9;c++){ const val = rows[r][c]; const d=document.createElement('div'); d.className='cell'+(val===null?' blank':''); d.textContent=val===null?'':val; d.dataset.val=val||''; d.addEventListener('click',()=>{ if(val!==null) d.classList.toggle('called'); }); grid.appendChild(d); } } }

function renderCalled(called){ const wrap=el('calledList'); wrap.innerHTML=''; called.forEach(n=>{ const d=document.createElement('div'); d.className='chip'; d.textContent=n; wrap.appendChild(d); }); el('lastCalled').textContent = called.length?called[called.length-1]:'â€”'; const cg = el('calledGridInner'); cg.innerHTML=''; for(let i=1;i<=90;i++){ const d=document.createElement('div'); d.className='cell'; d.textContent=i; if(called.includes(i)) d.classList.add('called'); cg.appendChild(d);} }

// -------------------------- State --------------------------
let gameState = {room:'ROOM123', called:[], started:false};
function updateUIRole(){ const role = el('modeHost').dataset.active==='true' ? 'host' : 'player'; el('hostControls').style.display = role==='host' ? 'block' : 'none'; el('playerControls').style.display = role==='player' ? 'block' : 'none'; }

// -------------------------- Deterministic caller --------------------------
function nextNumberForRoom(room,called){ const rand=seededRandom(room+':caller'); const seq=[]; while(seq.length<90){ const n=Math.floor(rand()*90)+1; if(!seq.includes(n)) seq.push(n); } for(const n of seq) if(!called.includes(n)) return n; return null; }

// -------------------------- Speech --------------------------
let voiceEnabled=true; let selectedVoiceLang='en-GB'; let chosenVoice=null;
function listVoices(){ const voices = speechSynthesis.getVoices(); // filter by language preference
  // try find GB first if selected
  if(selectedVoiceLang==='en-GB'){
    chosenVoice = voices.find(v=>v.lang && v.lang.toLowerCase().startsWith('en-gb')) || voices.find(v=>v.lang && v.lang.toLowerCase().startsWith('en')) || voices[0];
  } else {
    chosenVoice = voices.find(v=>v.lang && v.lang.toLowerCase().startsWith('en-us')) || voices.find(v=>v.lang && v.lang.toLowerCase().startsWith('en')) || voices[0];
  }
}
function speakText(txt){ if(!voiceEnabled) return; if(!chosenVoice) listVoices(); try{ const u = new SpeechSynthesisUtterance(txt); u.voice = chosenVoice; u.lang = chosenVoice && chosenVoice.lang ? chosenVoice.lang : selectedVoiceLang; u.rate = 0.95; speechSynthesis.cancel(); speechSynthesis.speak(u); }catch(e){ console.warn('Speech error',e); } }

// -------------------------- Events --------------------------
el('modeHost').addEventListener('click',()=>{ el('modeHost').dataset.active='true'; el('modePlayer').dataset.active='false'; updateUIRole(); });
el('modePlayer').addEventListener('click',()=>{ el('modeHost').dataset.active='false'; el('modePlayer').dataset.active='true'; updateUIRole(); });
el('modeHost').dataset.active='true'; el('modePlayer').dataset.active='false'; updateUIRole();

el('voiceSelect').addEventListener('change',(e)=>{ selectedVoiceLang = e.target.value==='gb' ? 'en-GB' : 'en-US'; listVoices(); });
el('voiceOnOff').addEventListener('click',()=>{ voiceEnabled=!voiceEnabled; el('voiceOnOff').textContent = voiceEnabled? 'ðŸ”ˆ On' : 'ðŸ”‡ Off'; });

el('startGame').addEventListener('click',()=>{ const room = el('roomCode').value || 'ROOM123'; gameState.room = room; gameState.started = true; gameState.called=[]; el('activeInfo').textContent = 'Game: ' + room + ' (started)'; renderCalled(gameState.called); el('shareBox').textContent=''; speakText('Game started for room ' + room); });

el('callNext').addEventListener('click',()=>{ if(!gameState.started){ alert('Start the game first'); return; } const n = nextNumberForRoom(gameState.room, gameState.called); if(n===null){ alert('All numbers called'); return; } gameState.called.push(n); renderCalled(gameState.called); updateShareBox(); const nick = nicknameFor(n); const announce = nick? `Number ${n}, ${nick}` : `Number ${n}`; speakText(announce); });

el('resetCalled').addEventListener('click',()=>{ if(confirm('Reset called numbers?')){ gameState.called=[]; renderCalled(gameState.called); updateShareBox(); speakText('Called numbers reset'); } });

el('copyState').addEventListener('click',()=>{ const s = encodeState(gameState); navigator.clipboard.writeText(location.origin + location.pathname + '#state=' + s).then(()=>{ el('shareBox').textContent='Link copied to clipboard'; el('shareBox').classList.add('copy-ok'); setTimeout(()=>el('shareBox').classList.remove('copy-ok'),1400); }); });

el('exportState').addEventListener('click',()=>{ const s=encodeState(gameState); prompt('Copy this state text to share with players:', s); });

el('getTicket').addEventListener('click',()=>{ const name = el('playerName').value.trim() || 'guest'; const room = el('roomCode').value || 'ROOM123'; const rows = generateTicket(room+':'+name); renderTicket(rows); el('ticketName').textContent = name + ' @ ' + room; });

el('regenTicket').addEventListener('click',()=>{ const name = el('playerName').value.trim() || 'guest'; const room = el('roomCode').value || 'ROOM123'; const rows = generateTicket(room+':'+name); renderTicket(rows); el('ticketName').textContent = name + ' @ ' + room; });

el('clearMarks').addEventListener('click',()=>{ const cells=document.querySelectorAll('#ticketGrid .cell'); cells.forEach(c=>c.classList.remove('called')); });

el('syncFromLink').addEventListener('click',()=>{ const txt = prompt('Paste state text (from host Export):'); if(!txt) return; try{ const s = txt.trim(); const st = decodeState(s); applyState(st); alert('State applied'); }catch(e){ alert('Invalid state text'); } });

el('downloadTicket').addEventListener('click',()=>{ downloadTicketImage(); });
el('downloadTicketImg').addEventListener('click',()=>{ downloadTicketImage(); });

function downloadTicketImage(){ const area = el('ticketArea'); if(typeof html2canvas==='undefined'){ alert('html2canvas not loaded â€” use browser screenshot'); return; } html2canvas(area,{scale:2}).then(canvas=>{ const link=document.createElement('a'); link.download='tambola-ticket.png'; link.href=canvas.toDataURL('image/png'); link.click(); }); }

// -------------------------- State encode/decode --------------------------
function encodeState(state){ const j = JSON.stringify({room:state.room,called:state.called,started:state.started}); return btoa(encodeURIComponent(j)); }
function decodeState(s){ const j = decodeURIComponent(atob(s)); return JSON.parse(j); }
function applyState(st){ gameState = st; renderCalled(gameState.called); el('roomCode').value = gameState.room; el('activeInfo').textContent = 'Game: ' + gameState.room + (gameState.started? ' (started)':''); el('shareBox').textContent = sDisplay(gameState); }
function sDisplay(st){ return 'Room:'+st.room+' Called:'+st.called.join(','); }
function updateShareBox(){ const s = encodeState(gameState); el('shareBox').textContent = s; }

// -------------------------- init --------------------------
renderCalled([]);
(function(){ try{ const h = location.hash; if(h && h.includes('state=')){ const s = h.split('state=')[1]; const st = decodeState(s); applyState(st); } }catch(e){} })();

// ensure voices available
if(typeof speechSynthesis!=='undefined'){
  // on some browsers voices load asynchronously
  listVoices(); if(speechSynthesis.onvoiceschanged!==undefined) speechSynthesis.onvoiceschanged = listVoices;
}

</script>
</body>
</html>
