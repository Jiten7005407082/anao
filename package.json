<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>E-Rickshaw Booking</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .section { margin-bottom: 15px; }
    #bookingsList div { border: 1px solid #ccc; padding: 8px; margin: 5px 0; }
  </style>
</head>
<body>
  <h2>ğŸš– E-Rickshaw Booking</h2>

  <div class="section">
    <label>Phone Number:</label><br>
    <input type="tel" id="phone" placeholder="Enter phone number" />
  </div>

  <div class="section">
    <label>Pickup Location:</label>
    <div id="pickupBox"></div>
  </div>

  <div class="section">
    <label>Drop Location:</label>
    <div id="dropBox"></div>
  </div>

  <div class="section">
    <button id="estimate">Estimate Fare</button>
    <div id="estimateBox"></div>
  </div>

  <div class="section">
    <button id="confirm">Confirm Booking</button>
  </div>

  <h3>ğŸ“‹ Your Bookings</h3>
  <div id="bookingsList"></div>

<script>
mapboxgl.accessToken = "YOUR_MAPBOX_ACCESS_TOKEN"; // replace with your Mapbox key

let pickupCoord=null, dropCoord=null, pickupName="", dropName="";

const pickupGeocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, placeholder: "Pickup location" });
pickupGeocoder.addTo("#pickupBox");
pickupGeocoder.on("result", e => {
  pickupCoord = e.result.geometry.coordinates;
  pickupName = e.result.place_name;
});

const dropGeocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, placeholder: "Drop location" });
dropGeocoder.addTo("#dropBox");
dropGeocoder.on("result", e => {
  dropCoord = e.result.geometry.coordinates;
  dropName = e.result.place_name;
});

const baseFare=15, perKm=8;

async function getRouteDistance(pickup,drop){
  const url=`https://api.mapbox.com/directions/v5/mapbox/driving/${pickup[0]},${pickup[1]};${drop[0]},${drop[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`;
  const res=await fetch(url);
  const data=await res.json();
  if(!data.routes || !data.routes.length) return null;
  return data.routes[0].distance/1000; // metersâ†’km
}

document.getElementById("estimate").onclick=async()=>{
  if(!pickupCoord||!dropCoord){ estimateBox.textContent="Select pickup & drop"; return; }
  const km=await getRouteDistance(pickupCoord,dropCoord);
  if(!km){ estimateBox.textContent="No route found"; return; }
  const fare=Math.round(baseFare+perKm*km);
  estimateBox.textContent=`Distance: ${km.toFixed(2)} km â€” Fare: â‚¹${fare}`;
  window.currentEstimate={km,fare};
};

document.getElementById("confirm").onclick=()=>{
  const phone=document.getElementById("phone").value.trim();
  if(!phone){ alert("Enter phone number"); return; }
  if(!pickupCoord||!dropCoord||!window.currentEstimate){ alert("Select pickup & drop and estimate fare"); return; }
  
  const now=new Date();
  const datetime=now.toLocaleString();

  const bookings=JSON.parse(localStorage.getItem("erick_bookings")||"[]");
  bookings.unshift({
    phone,
    pickup:pickupName,
    drop:dropName,
    fare:window.currentEstimate.fare,
    datetime,
    status:"active"
  });
  localStorage.setItem("erick_bookings",JSON.stringify(bookings));
  loadBookings();
};

function loadBookings(){
  const arr=JSON.parse(localStorage.getItem("erick_bookings")||"[]");
  bookingsList.innerHTML="";
  if(!arr.length){ bookingsList.textContent="No bookings yet"; return; }
  arr.forEach((b,i)=>{
    const div=document.createElement("div");
    div.innerHTML=`
      <b>Trip #${i+1}</b><br>
      ğŸ“ ${b.phone}<br>
      ğŸ“ ${b.pickup} â†’ ${b.drop}<br>
      ğŸ’° Fare: â‚¹${b.fare}<br>
      ğŸ•’ ${b.datetime}<br>
      Status: ${b.status}
    `;
    if(b.status==="active"){
      const btn=document.createElement("button");
      btn.textContent="End Trip";
      btn.onclick=()=>{
        arr.splice(i,1); // delete booking after trip ends
        localStorage.setItem("erick_bookings",JSON.stringify(arr));
        loadBookings();
      };
      div.appendChild(document.createElement("br"));
      div.appendChild(btn);
    }
    bookingsList.appendChild(div);
  });
}
loadBookings();
</script>
</body>
</html>
