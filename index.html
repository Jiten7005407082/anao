<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Voice Changer â€“ Mic & Audio File</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: Arial, sans-serif;
  background: #0a1e44;
  color: #fff;
  text-align: center;
  padding: 30px;
}
button, select, input {
  padding: 10px;
  margin: 10px;
  font-size: 16px;
}
select {
  width: 220px;
}
</style>
</head>
<body>

<h1>Advanced Voice Changer</h1>

<h3>Microphone Input</h3>
<button onclick="startMic()">Start Microphone</button>

<hr>

<h3>Upload Audio File</h3>
<input type="file" accept="audio/*" onchange="loadAudioFile(event)">
<button onclick="playAudio()">Play Audio</button>

<hr>

<label>Voice Effect</label><br>
<select id="effect" onchange="changeEffect()">
  <option value="normal">Normal</option>
  <option value="deep">Deep Voice</option>
  <option value="high">High Voice</option>
  <option value="robot">Robot</option>
  <option value="echo">Echo</option>
  <option value="alien">Alien</option>
</select>

<br>

<label>Pitch Control</label><br>
<input type="range" min="0.5" max="2" step="0.1" value="1" id="pitch">

<script>
let audioContext;
let sourceNode;
let audioBuffer;
let pitchNode;
let delayNode;
let gainNode;
let distortion;

function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    pitchNode = audioContext.createPlaybackRate();
    delayNode = audioContext.createDelay();
    gainNode = audioContext.createGain();
    distortion = audioContext.createWaveShaper();

    document.getElementById("pitch").oninput = function () {
      pitchNode.playbackRate.value = this.value;
    };
  }
}

async function startMic() {
  initAudio();
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  sourceNode = audioContext.createMediaStreamSource(stream);
  connectNormal();
}

function loadAudioFile(event) {
  initAudio();
  const file = event.target.files[0];
  const reader = new FileReader();

  reader.onload = function(e) {
    audioContext.decodeAudioData(e.target.result, function(buffer) {
      audioBuffer = buffer;
    });
  };
  reader.readAsArrayBuffer(file);
}

function playAudio() {
  if (!audioBuffer) return alert("Please upload an audio file first.");
  sourceNode = audioContext.createBufferSource();
  sourceNode.buffer = audioBuffer;
  sourceNode.loop = false;
  connectNormal();
  sourceNode.start(0);
}

function resetConnections() {
  try { sourceNode.disconnect(); } catch {}
  try { pitchNode.disconnect(); } catch {}
  try { delayNode.disconnect(); } catch {}
  try { gainNode.disconnect(); } catch {}
  try { distortion.disconnect(); } catch {}
}

function connectNormal() {
  resetConnections();
  pitchNode.playbackRate.value = document.getElementById("pitch").value;
  sourceNode.connect(pitchNode).connect(audioContext.destination);
}

function connectDeep() {
  resetConnections();
  pitchNode.playbackRate.value = 0.7;
  sourceNode.connect(pitchNode).connect(audioContext.destination);
}

function connectHigh() {
  resetConnections();
  pitchNode.playbackRate.value = 1.5;
  sourceNode.connect(pitchNode).connect(audioContext.destination);
}

function connectEcho() {
  resetConnections();
  delayNode.delayTime.value = 0.3;
  gainNode.gain.value = 0.6;

  sourceNode.connect(delayNode);
  delayNode.connect(gainNode);
  gainNode.connect(audioContext.destination);
}

function connectRobot() {
  resetConnections();
  distortion.curve = makeDistortionCurve(400);
  distortion.oversample = "4x";
  sourceNode.connect(distortion).connect(audioContext.destination);
}

function connectAlien() {
  resetConnections();
  pitchNode.playbackRate.value = 1.2;
  delayNode.delayTime.value = 0.15;
  gainNode.gain.value = 0.7;

  sourceNode.connect(pitchNode);
  pitchNode.connect(delayNode);
  delayNode.connect(gainNode);
  gainNode.connect(audioContext.destination);
}

function changeEffect() {
  const effect = document.getElementById("effect").value;
  if (!sourceNode) return;

  if (effect === "normal") connectNormal();
  if (effect === "deep") connectDeep();
  if (effect === "high") connectHigh();
  if (effect === "echo") connectEcho();
  if (effect === "robot") connectRobot();
  if (effect === "alien") connectAlien();
}

function makeDistortionCurve(amount) {
  let n_samples = 44100;
  let curve = new Float32Array(n_samples);
  let deg = Math.PI / 180;

  for (let i = 0; i < n_samples; i++) {
    let x = i * 2 / n_samples - 1;
    curve[i] = (3 + amount) * x * 20 * deg / (Math.PI + amount * Math.abs(x));
  }
  return curve;
}
</script>

</body>
</html>
